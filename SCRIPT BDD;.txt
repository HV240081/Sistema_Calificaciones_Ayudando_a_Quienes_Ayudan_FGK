CREATE DATABASE PROYECTO_ES;

USE PROYECTO_ES;

CREATE TABLE ROL (
    ID_ROL INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    ROL VARCHAR(50) NOT NULL
);

CREATE TABLE USUARIO (
    ID_USUARIO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NOMBRE VARCHAR(25) NOT NULL,
    APELLIDO VARCHAR(30) NOT NULL,
    CONTRASENA VARCHAR(9) NOT NULL,
    TEMPORAL TINYINT NOT NULL,
    ID_ROL INT NOT NULL,
    FOREIGN KEY (ID_ROL) REFERENCES ROL(ID_ROL)
);

CREATE TABLE PERMISOS (
    ID_PERMISO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    PERMISO VARCHAR(2) NOT NULL,
    DESCRIPCION VARCHAR(50) NOT NULL
);

INSERT INTO `permisos` (`ID_PERMISO`, `PERMISO`, `DESCRIPCION`) VALUES
(1, 'JU', ''),
(2, 'AD', '')

CREATE TABLE ACTIVIDAD (
    ID_ACTIVIDAD INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NOM_ACTIVIDAD VARCHAR(30) NOT NULL,
    PORCENTAJE DOUBLE(5,2) NOT NULL,
    DESCRIPCION VARCHAR(60) NOT NULL,
    ID_PERMISO INT NOT NULL,
    FOREIGN KEY (ID_PERMISO) REFERENCES PERMISOS(ID_PERMISO)
);

CREATE TABLE PROYECTO (
    ID_PROYECTO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    PROYECTO VARCHAR(150) NOT NULL,
    DESCRIPCION VARCHAR(200) NOT NULL
);

CREATE TABLE CALIFICACION (
    ID_CALIFICACION INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    CALIFICACION DOUBLE(5,2) NOT NULL,
    ID_ACTIVIDAD INT NOT NULL,
    ID_PROYECTO INT NOT NULL,
    FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO(ID_PROYECTO),
    FOREIGN KEY (ID_ACTIVIDAD) REFERENCES ACTIVIDAD(ID_ACTIVIDAD)
);

CREATE TABLE NOTAS (
    ID_NOTAS INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    COMENTARIOS VARCHAR(200) NOT NULL,
    CALIFICACION DOUBLE(5,2) NOT NULL,
    ID_USUARIO INT NOT NULL,
    ID_PROYECTO INT NOT NULL,
    ID_CALIFICACION INT NOT NULL,
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO),
    FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO(ID_PROYECTO),
    FOREIGN KEY (ID_CALIFICACION) REFERENCES CALIFICACION(ID_CALIFICACION)
);

CREATE TABLE CRITERIO (
    ID_CRITERIO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    CRITERIO VARCHAR(50) NOT NULL,
    PORCENTAJE DOUBLE(5,2) NOT NULL,
    DESCRIPCION VARCHAR(100) NOT NULL,
    ID_ACTIVIDAD INT NOT NULL,
    FOREIGN KEY (ID_ACTIVIDAD) REFERENCES ACTIVIDAD(ID_ACTIVIDAD)
);

CREATE TABLE NOTA_CRITERIO (
    ID_NOTACRITERIO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NOTA DOUBLE(4,2) NOT NULL,
    ID_CRITERIO INT NOT NULL,
    ID_USUARIO INT NOT NULL,
    FOREIGN KEY (ID_CRITERIO) REFERENCES CRITERIO(ID_CRITERIO),
    FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO)
);

CREATE TABLE NOTA_CRITERIO_CALIFICACION (
    ID_NOTA_CRITERIO_CALIFICACION INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    ID_NOTA_CRITERIO INT NOT NULL,
    ID_CALIFICACION INT NOT NULL,
    FOREIGN KEY (ID_NOTA_CRITERIO) REFERENCES NOTA_CRITERIO(ID_NOTACRITERIO),
    FOREIGN KEY (ID_CALIFICACION) REFERENCES CALIFICACION(ID_CALIFICACION)
);

CREATE TABLE NFINAL (
    ID_NFINAL INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    NOTA_FINAL DOUBLE(4,2) NOT NULL,
    ID_PROYECTO INT NOT NULL,
    ID_ACTIVIDAD INT NOT NULL,
    FOREIGN KEY (ID_PROYECTO) REFERENCES PROYECTO(ID_PROYECTO),
    FOREIGN KEY (ID_ACTIVIDAD) REFERENCES ACTIVIDAD(ID_ACTIVIDAD)
);

CREATE TABLE NOTAS_NFINAL (
    ID_NOTAS_NFINAL INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    ID_NOTA INT NOT NULL,
    ID_NFINAL INT NOT NULL,
    FOREIGN KEY (ID_NOTA) REFERENCES NOTAS(ID_NOTAS),
    FOREIGN KEY (ID_NFINAL) REFERENCES NFINAL(ID_NFINAL)
);

CREATE TABLE PREMIO (
    ID_PREMIO INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    PREMIO VARCHAR(50) NOT NULL,
    DESCRIPCION VARCHAR(100) NOT NULL
);

CREATE TABLE PREMIO_NFINAL (
    ID_PREMIO_NFINAL INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
    ID_PREMIO INT NOT NULL,
    ID_NFINAL INT NOT NULL,
    FOREIGN KEY (ID_PREMIO) REFERENCES PREMIO(ID_PREMIO),
    FOREIGN KEY (ID_NFINAL) REFERENCES NFINAL(ID_NFINAL)
);

INSERT INTO ROL (ROL) VALUES 
('ADMINISTRADOR'),
('EVALUADOR');
(JURADOPRINCIPAL);

INSERT INTO USUARIO (NOMBRE, APELLIDO, CONTRASENA, TEMPORAL, ID_ROL) VALUES
('Alexis', 'Cisneros', 'proyecto_','1','1'),
('Angie', 'Valencia', 'proyecto_','1','2'),
('Admin', 'Admin', 'proyecto_','1','1');

-- INSERTS PARA CRITERIOS DEL PITCH 70%
INSERT INTO CRITERIO (CRITERIO, PORCENTAJE, DESCRIPCION, ID_ACTIVIDAD) VALUES
('Impacto Económico', 14.30, 'Evaluación del impacto económico del proyecto', 10),
('Impacto Social', 14.30, 'Evaluación del impacto social del proyecto', 10),
('Impacto Ambiental', 14.30, 'Evaluación del impacto ambiental del proyecto', 10),
('Sostenibilidad del Proyecto', 14.30, 'Evaluación de la sostenibilidad del proyecto', 10),
('Crecimiento Potencial', 14.30, 'Evaluación del potencial de crecimiento', 10),
('Innovación', 14.30, 'Evaluación del nivel de innovación', 10),
('Promedio del Proyecto', 14.10, 'Evaluación general del proyecto', 10);

-- OPCIONAL: Si necesitas modificar las constraints para DELETE CASCADE, hazlo por separado:
/*
-- Eliminar las constraints existentes (solo si es necesario)
ALTER TABLE NOTAS DROP FOREIGN KEY NOTAS_ibfk_3;
ALTER TABLE NOTA_CRITERIO_CALIFICACION DROP FOREIGN KEY NOTA_CRITERIO_CALIFICACION_ibfk_2;

-- Crear las nuevas constraints con ON DELETE CASCADE
ALTER TABLE NOTAS 
ADD CONSTRAINT NOTAS_ibfk_3 
FOREIGN KEY (ID_CALIFICACION) REFERENCES CALIFICACION(ID_CALIFICACION) 
ON DELETE CASCADE;

ALTER TABLE NOTA_CRITERIO_CALIFICACION 
ADD CONSTRAINT NOTA_CRITERIO_CALIFICACION_ibfk_2 
FOREIGN KEY (ID_CALIFICACION) REFERENCES CALIFICACION(ID_CALIFICACION) 
ON DELETE CASCADE;

